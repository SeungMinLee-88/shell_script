#!/bin/bash
TARGETPATH=targetconfig
CHECKRESULT=targetconfig/vulcheckresult.txt
if [ -e "$CHECKRESULT" ] # $filename 에 빈 칸이 들어 있을 수도 있기 때문에 쿼우팅해줍니다.
then
    echo "file extis"
else
    echo "file not extis"
    exit 0
fi
RHELVER=$(awk '{ print $4 }' /etc/redhat-release | awk -F. '{ print $1 }')
echo $RHELVER
RHELVER=7
EXITSCONFIG=
PWCOMPRLT=$(sed -n '/PASSWORD COMPLEXITY : DETECTED/p' $CHECKRESULT)
echo "PWCOMPRLT: "$PWCOMPRLT

if [[ RHELVER -eq "5" ]]
then
    if [[ -z "$PWCOMPRLT" ]] # value is null
    then
        echo "null"
    else
        ##ex extest +/password    requisite/ +'d' +'15p'  +'i|password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 difok=N'  -s +'1,$|w|q!'
        echo "cat -n $TARGETPATH/system-auth_test |sed -n '/password    requisite     pam_cracklib.so/p' | awk '{ print $1 }'"
        EXITSCONFIG=$(cat -n $TARGETPATH/system-auth_test |sed -n '/password    requisite     pam_cracklib.so/p' | awk '{ print $1 }')
        echo "EXITSCONFIG :"$EXITSCONFIG
        if [[ -n "$EXITSCONFIG" ]] # value is not null
        then
            echo "thenthenthenthenthenthenthenthenthen"
            ex $TARGETPATH/system-auth_test +/"password    requisite     pam_cracklib.so"/ +'d' +'i|password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 difok=N'  -s +'1,$|w|q!'
        else
            echo "elseelseelseelseelseelseelseelseelse"
            ex $TARGETPATH/system-auth_test +/"password    required"/ +'i|password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 difok=N'  -s +'1,$|w|q!'
        fi

    fi
fi
EXITSCONFIG=
PWCOMPRLT=$(sed -n '/PASSWORD COMPLEXITY : DETECTED/p' $CHECKRESULT)
if [[ RHELVER -eq "7" ]]
then
    if [[ -z "$PWCOMPRLT" ]] # value is null
    then
    echo "null"
    else
        CHKVALUE=("# retry = 3" "# minlen = -1" "# lcredit = -1" "# ucredit = -1" "# dcredit = -1" "# difok = N")
          ELEMENT_COUNT=${#CHKVALUE[@]}
          INDEX=0
          echo "ELEMENT_COUNT :"$ELEMENT_COUNT
            while [ "$INDEX" -lt "$ELEMENT_COUNT" ]
            do
                #echo ${CHKVALUE[$INDEX]}
                FINDTEXT=$(echo "${CHKVALUE[$INDEX]}" | awk '{ print $1" "$2" "$3 }')
                #echo 'cat -n $TARGETPATH/pwquality.conf_test |sed -n '/$FINDTEXT/p' | awk '{ print $1 }''

                EXITSCONFIG=$(cat -n $TARGETPATH/pwquality.conf_test |sed -n "/$FINDTEXT/p" | awk '{ print $1 }')
                echo "EXITSCONFIG :"$EXITSCONFIG

                if [[ -n "$EXITSCONFIG" ]] # value is not null
                then
                    echo "thenthenthenthenthenthenthenthenthen"
                    CHGTEXT=$(echo "${CHKVALUE[$INDEX]}" | awk '{ print $2" "$3" "$4 }')

                    sed -i "s/$FINDTEXT/$CHGTEXT/g" $TARGETPATH/pwquality.conf_test
                    #ex $TARGETPATH/system-auth_test +/"password    requisite     pam_cracklib.so"/ +'d' +'i|password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 difok=N'  -s +'1,$|w|q!'
                else
                    echo "elseelseelseelseelseelseelseelseelse"
                    CHGTEXT=$(echo "${CHKVALUE[$INDEX]}" | awk '{ print $2" "$3" "$4 }')
                    sed -i "/# dictpath =/a $CHGTEXT" $TARGETPATH/pwquality.conf_test
                    #ex $TARGETPATH/system-auth_test +/"password    required"/ +'i|password    requisite     pam_cracklib.so try_first_pass retry=3 minlen=8 lcredit=-1 ucredit=-1 dcredit=-1 difok=N'  -s +'1,$|w|q!'
                fi


                let "INDEX = $INDEX + 1"

            done

    fi
fi
